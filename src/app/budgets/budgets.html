<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <h2>Budget Management</h2>
      <p class="text-muted">Set and track your spending limits by category</p>
    </div>
  </div>

  <!-- Budget Creation Form -->
  <div class="row mb-4">
    <div class="col-md-8 offset-md-2">
      <div class="card">
        <div class="card-header">
          <h5>Create New Budget</h5>
        </div>
        <div class="card-body">
          <form [formGroup]="budgetForm" (ngSubmit)="onSubmit()" class="needs-validation" novalidate>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="name" class="form-label">Budget Name</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    id="name" 
                    formControlName="name"
                    placeholder="e.g., Monthly Grocery Budget"
                    [class.is-invalid]="budgetForm.get('name')?.invalid && budgetForm.get('name')?.touched">
                  <div 
                    *ngIf="budgetForm.get('name')?.invalid && budgetForm.get('name')?.touched" 
                    class="invalid-feedback">
                    Budget name is required (minimum 3 characters)
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="categoryId" class="form-label">Category</label>
                  <select 
                    class="form-select" 
                    id="categoryId" 
                    formControlName="categoryId"
                    [class.is-invalid]="budgetForm.get('categoryId')?.invalid && budgetForm.get('categoryId')?.touched">
                    <option value="">Select a category</option>
                    <option *ngFor="let category of expenseCategories" [value]="category">{{ category }}</option>
                  </select>
                  <div 
                    *ngIf="budgetForm.get('categoryId')?.invalid && budgetForm.get('categoryId')?.touched" 
                    class="invalid-feedback">
                    Please select a category
                  </div>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="amount" class="form-label">Budget Amount</label>
                  <input 
                    type="number" 
                    class="form-control" 
                    id="amount" 
                    formControlName="amount"
                    min="0.01" 
                    step="0.01"
                    placeholder="0.00"
                    [class.is-invalid]="budgetForm.get('amount')?.invalid && budgetForm.get('amount')?.touched">
                  <div 
                    *ngIf="budgetForm.get('amount')?.invalid && budgetForm.get('amount')?.touched" 
                    class="invalid-feedback">
                    Amount is required and must be greater than 0
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="period" class="form-label">Period</label>
                  <select 
                    class="form-select" 
                    id="period" 
                    formControlName="period"
                    [class.is-invalid]="budgetForm.get('period')?.invalid && budgetForm.get('period')?.touched">
                    <option *ngFor="let period of periods" [value]="period.value">{{ period.label }}</option>
                  </select>
                  <div 
                    *ngIf="budgetForm.get('period')?.invalid && budgetForm.get('period')?.touched" 
                    class="invalid-feedback">
                    Please select a period
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="startDate" class="form-label">Start Date</label>
                  <input 
                    type="date" 
                    class="form-control" 
                    id="startDate" 
                    formControlName="startDate"
                    [class.is-invalid]="budgetForm.get('startDate')?.invalid && budgetForm.get('startDate')?.touched">
                  <div 
                    *ngIf="budgetForm.get('startDate')?.invalid && budgetForm.get('startDate')?.touched" 
                    class="invalid-feedback">
                    Please select a start date
                  </div>
                </div>
              </div>
            </div>
            
            <div class="d-grid">
              <button 
                type="submit" 
                class="btn btn-primary btn-lg"
                [disabled]="budgetForm.invalid">
                Create Budget
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Budget Charts Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5>Budget Overview</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <div class="chart-container" style="height: 400px;">
                <canvas 
                  baseChart
                  [data]="budgetChartData"
                  [options]="chartOptions"
                  [type]="budgetChartType">
                </canvas>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Budget Summary</h5>
                  <p class="card-text">
                    <strong>Total Budgets:</strong> {{ totalBudgets }}<br>
                    <strong>Total Allocated:</strong> PKR {{ totalAllocated | number:'1.2-2' }}<br>
                    <strong>Total Spent:</strong> PKR {{ totalSpent | number:'1.2-2' }}<br>
                    <strong>Remaining:</strong> PKR {{ totalRemaining | number:'1.2-2' }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Budget List -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5>Active Budgets</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Budget</th>
                  <th>Spent</th>
                  <th>Remaining</th>
                  <th>Period</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngIf="budgets.length === 0">
                  <td colspan="8" class="text-center text-muted">
                    No budgets created yet. Create your first budget above.
                  </td>
                </tr>
                <tr *ngFor="let budget of budgets">
                  <td>{{ budget.name }}</td>
                  <td><span class="badge bg-primary">{{ budget.categoryId }}</span></td>
                  <td>PKR {{ budget.amount | number:'1.2-2' }}</td>
                  <td>PKR {{ budget.currentSpent | number:'1.2-2' }}</td>
                  <td>
                    <span [class.text-success]="budget.remainingAmount >= 0" 
                          [class.text-danger]="budget.remainingAmount < 0">
                      PKR {{ budget.remainingAmount | number:'1.2-2' }}
                    </span>
                  </td>
                  <td>{{ budget.period | titlecase }}</td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="flex-grow-1 me-2">
                        <div class="progress" style="height: 10px;">
                          <div 
                            class="progress-bar" 
                            role="progressbar" 
                            [style.width.%]="budget.spentPercentage"
                            [ngClass]="getBudgetStatusClass(budget)"
                            [attr.aria-valuenow]="budget.spentPercentage"
                            aria-valuemin="0" 
                            aria-valuemax="100">
                          </div>
                        </div>
                      </div>
                      <span class="small">{{ budget.spentPercentage | number:'1.0-0' }}%</span>
                    </div>
                  </td>
                  <td>
                    <button 
                      class="btn btn-sm btn-outline-danger" 
                      (click)="deleteBudget(budget.id)"
                      title="Delete">
                      <i class="bi bi-trash"></i> Delete
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>